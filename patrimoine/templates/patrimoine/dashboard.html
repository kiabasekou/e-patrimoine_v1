{% extends 'base.html' %}

{% block title %}Tableau de bord{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h1>üìä Tableau de bord</h1>

    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'biens:dashboard' %}?format=excel" class="btn btn-success me-2">üì• Export Excel</a>
      <a href="{% url 'biens:dashboard' %}?format=pdf" class="btn btn-danger">üñ®Ô∏è Export PDF</a>
    </div>

    <form method="get" class="row g-3 align-items-end mb-4">
      <div class="col-md-4">
        <label for="annee" class="form-label">Filtrer par ann√©e</label>
        <select name="annee" id="annee" class="form-select">
          <option value="">-- Toutes les ann√©es --</option>
          {% for an in annees_disponibles %}
            <option value="{{ an }}" {% if an|stringformat:"s" == annee %}selected{% endif %}>{{ an }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="province" class="form-label">Filtrer par province</label>
        <select name="province" id="province" class="form-select">
          <option value="">-- Toutes les provinces --</option>
          {% for p in provinces %}
            <option value="{{ p.id }}" {% if p.id|stringformat:"s" == province %}selected{% endif %}>{{ p.nom }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary">üîç Filtrer</button>
        <a href="{% url 'biens:dashboard' %}" class="btn btn-outline-secondary">‚ôªÔ∏è R√©initialiser</a>
      </div>
    </form>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">üí∞ Valeur totale du patrimoine</h5>
        <p class="card-text">{{ valeur_totale|floatformat:"0" }} FCFA</p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">R√©partition des biens par cat√©gorie</h5>
        {% if par_categorie %}
          <ul class="list-group list-group-flush">
            {% for cat in par_categorie %}
              <li class="list-group-item">
                {{ cat.categorie__nom }} : <span class="badge bg-primary">{{ cat.nb_biens }} biens</span> ‚Äì
                <span class="badge bg-success">{{ cat.total|floatformat:"0" }} FCFA</span>
              </li>
            {% endfor %}
          </ul>
          <canvas id="categorieChart" class="mt-4" height="100"></canvas>
        {% else %}
          <p class="text-muted">Aucune donn√©e de r√©partition par cat√©gorie.</p>
        {% endif %}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">R√©partition par entit√©</h5>
        {% if par_entite %}
          <ul class="list-group list-group-flush">
            {% for ent in par_entite %}
              <li class="list-group-item">
                {{ ent.entite__nom }} : <span class="badge bg-info">{{ ent.nb_biens }} biens</span> ‚Äì
                <span class="badge bg-warning">{{ ent.total|floatformat:"0" }} FCFA</span>
              </li>
            {% endfor %}
          </ul>
          <canvas id="entiteChart" class="mt-4" height="100"></canvas>
        {% else %}
          <p class="text-muted">Aucune donn√©e de r√©partition par entit√©.</p>
        {% endif %}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">R√©partition par province</h5>
        {% if par_province %}
          <ul class="list-group list-group-flush">
            {% for prov in par_province %}
              <li class="list-group-item">
                {{ prov.province__nom }} : <span class="badge bg-secondary">{{ prov.nb_biens }} biens</span> ‚Äì
                <span class="badge bg-dark">{{ prov.total|floatformat:"0" }} FCFA</span>
              </li>
            {% endfor %}
          </ul>
          <canvas id="provinceChart" class="mt-4" height="100"></canvas>
        {% else %}
          <p class="text-muted">Aucune donn√©e de r√©partition par province.</p>
        {% endif %}
      </div>
    </div>

    <div class="alert alert-info mt-3" role="alert">
      Ceci est un aper√ßu de votre tableau de bord. Des visualisations plus d√©taill√©es pourraient √™tre ajout√©es ici.
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const catLabels = {{ categorie_labels|safe }};
  const catData = {{ categorie_data|safe }};
  const entLabels = {{ entite_labels|safe }};
  const entData = {{ entite_data|safe }};
  const provLabels = {{ province_labels|safe }};
  const provData = {{ province_data|safe }};

  const ctxCat = document.getElementById('categorieChart');
  if (ctxCat) {
    new Chart(ctxCat, {
      type: 'bar',
      data: {
        labels: catLabels,
        datasets: [{
          label: 'Nombre de biens par cat√©gorie',
          data: catData,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  const ctxEnt = document.getElementById('entiteChart');
  if (ctxEnt) {
    new Chart(ctxEnt, {
      type: 'pie',
      data: {
        labels: entLabels,
        datasets: [{
          label: 'R√©partition par entit√©',
          data: entData,
          backgroundColor: [
            '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#20c997', '#fd7e14'
          ]
        }]
      },
      options: {
        responsive: true
      }
    });
  }

  const ctxProv = document.getElementById('provinceChart');
  if (ctxProv) {
    new Chart(ctxProv, {
      type: 'doughnut',
      data: {
        labels: provLabels,
        datasets: [{
          label: 'R√©partition par province',
          data: provData,
          backgroundColor: [
            '#6f42c1', '#20c997', '#0dcaf0', '#ffc107', '#dc3545', '#198754', '#6610f2', '#fd7e14', '#0d6efd'
          ]
        }]
      },
      options: {
        responsive: true
      }
    });
  }
</script>
{% endblock %}
