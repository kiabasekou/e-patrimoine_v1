{% extends 'base.html' %}

{% block title %}
  {% if view.kwargs.pk %}Modifier « {{ object.nom }} »{% else %}Ajouter un nouveau bien{% endif %} | Gestion du Patrimoine
{% endblock title %}

{% block content %}
<div class="container mt-4">
  <h1>
    {% if view.kwargs.pk %}✏️ Modifier« {{ object.nom }} »{% else %}➕ Ajouter un nouveau bien{% endif %}
  </h1>
  <form method="post" enctype="multipart/form-data" id="bien-form">
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-6">
        <label for="id_nom" class="form-label">Nom</label>
        {{ form.nom }}
        {% for err in form.nom.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        <label for="id_entite" class="form-label">Entité</label>
        {{ form.entite }}
        {% for err in form.entite.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        <label for="id_categorie" class="form-label">Catégorie</label>
        {{ form.categorie }}
        {% for err in form.categorie.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        <label for="id_sous_categorie" class="form-label">Sous‑catégorie</label>
        {{ form.sous_categorie }}
        {% for err in form.sous_categorie.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label for="id_valeur_initiale" class="form-label">Valeur initiale</label>
        {{ form.valeur_initiale }}
        {% for err in form.valeur_initiale.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label for="id_date_acquisition" class="form-label">Date d’acquisition</label>
        {{ form.date_acquisition }}
        {% for err in form.date_acquisition.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
      <div class="col-md-4">
        <label for="id_justificatif" class="form-label">Justificatif</label>
        {{ form.justificatif }}
        {% for err in form.justificatif.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
    </div>

    <div id="profil-form-container" class="mt-4"></div>

    <div class="mt-3 d-flex justify-content-end gap-2">
      <a href="{% url 'biens:bien_list' %}" class="btn btn-secondary">Annuler</a>
      <button type="submit" class="btn btn-success">
        {% if view.kwargs.pk %}💾 Enregistrer{% else %}✔️ Créer{% endif %}
      </button>
    </div>
  </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const cat = document.getElementById('id_categorie');
  const sous = document.getElementById('id_sous_categorie');
  const profilContainer = document.getElementById('profil-form-container');

  cat?.addEventListener('change', () => {
    fetch("{% url 'biens:ajax_load_sous_categories' %}?categorie=" + cat.value)
      .then(r => r.text())
      .then(html => {
        sous.innerHTML = html;
        profilContainer.innerHTML = '';
      })
      .catch(console.error);
  });

  sous?.addEventListener('change', () => {
    if (!sous.value) return;
    fetch("{% url 'biens:get_profil_form' %}?sous_categorie_id=" + sous.value)
      .then(r => r.json())
      .then(data => profilContainer.innerHTML = data.form || '')
      .catch(console.error);
  });
});
</script>
{% endblock extra_js %}
